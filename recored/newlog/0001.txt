============================================================================================================================================================================================================================================================================================================================================================================
.faq 
查看窗口功能



============================================================================================================================================================================================================================================================================================================================================================================
HWND hd=FindWindow("ollydbg",NULL);
BYTE *address=(BYTE *)GetProcAddress(LoadLibrary("user32.dll"),"BlockInput");
ExitProcess




//tls
int __userpurge sub_6642F3D2@<eax>(int a1@<ebp>, int a2, int a3, int a4)
{
  int result; // eax@1
  int (**i)(void); // esi@2
  int (*v6)(void); // edi@4
  int v7; // et1@8

  result = sub_663D18E8(&unk_6644DC10, 12);
  if ( *(_DWORD *)(a1 + 12) == 2 )
  {
    *(_DWORD *)(a1 - 4) = 0;
    for ( i = (int (**)(void))&unk_6643A41C; ; ++i )
    {
      *(_DWORD *)(a1 - 28) = i;
      if ( (_UNKNOWN *)i == &unk_6643A51C )
        break;
      v6 = *i;
      if ( *i )
      {
        __guard_check_icall_fptr(*i);
        result = v6();
      }
    }
    *(_DWORD *)(a1 - 4) = -2;
  }
  v7 = *(_DWORD *)(a1 - 16);
  return result;
}

============================================================================================================================================================================================================================================================================================================================================================================
QQ登录时启动两进程: 1,登录框进进程; 2,登录成功处理进程
登录成功后,登录框进程会退出
//exitprocess
Address=6C342B04   => 6C342B0A
Module/Label/Exception=hummerengine.dll
 

Base=6C330000
Module=hummerengine.dll


--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
int __cdecl sub_6C342AA7(int a1)
{
  DWORD v1; // ecx@0
  int *v2; // eax@1
  int v3; // ST1C_4@1
  DWORD v5; // [sp+0h] [bp-4h]@1
  TXLog *savedregs; // [sp+4h] [bp+0h]@1

  v5 = v1;
  dword_6C365770 = 1;
  GetCallStack(&v5, 50, 0);
  v3 = *v2;
  sub_6C331B89(L"file", 159, L"func", 2, L"ExitInfo", L"exit(0x%x) callstack: \r\n%s", a1);
  CTXStringW::~CTXStringW((CTXStringW *)&v5);
  TXLog::FlushLog(savedregs);
  return dword_6C36689C(a1);
}

//引用 sub_6C342AA7
void *__usercall sub_6C343AA2@<eax>(unsigned __int32 *a1@<edi>)
{
  char v1; // bl@6
  DWORD v2; // esi@19
  WCHAR *v3; // eax@19
  DWORD v4; // ST50_4@19
  wchar_t *lpProcName; // ST44_4@19
  wchar_t *i; // eax@19
  HMODULE v7; // eax@25
  HMODULE v8; // esi@25
  FARPROC v9; // eax@25
  FARPROC v10; // eax@27
  FARPROC v11; // eax@29
  HMODULE v12; // eax@31
  FARPROC v13; // eax@31
  HMODULE v14; // esi@33
  FARPROC v15; // eax@34
  __int16 v16; // ax@40
  int v17; // ebx@54
  FARPROC v18; // eax@58
  FARPROC v19; // eax@58
  DWORD v20; // eax@60
  const wchar_t *v21; // eax@60
  HMODULE v22; // eax@61
  FARPROC v23; // eax@61
  int v25; // [sp+4Ch] [bp-A80h]@25
  DWORD v26; // [sp+54h] [bp-A78h]@19
  FARPROC v27; // [sp+60h] [bp-A6Ch]@25
  FARPROC v28; // [sp+64h] [bp-A68h]@31
  FARPROC v29; // [sp+68h] [bp-A64h]@29
  FARPROC v30; // [sp+6Ch] [bp-A60h]@32
  DWORD pcbBuffer; // [sp+70h] [bp-A5Ch]@2
  HMODULE v32; // [sp+74h] [bp-A58h]@33
  char *Str1; // [sp+78h] [bp-A54h]@34
  int v34; // [sp+7Ch] [bp-A50h]@34
  void *Memory; // [sp+80h] [bp-A4Ch]@25
  int v36; // [sp+84h] [bp-A48h]@25
  int v37; // [sp+88h] [bp-A44h]@25
  char v38; // [sp+8Ch] [bp-A40h]@19
  int v39; // [sp+90h] [bp-A3Ch]@8
  int (__cdecl *v40)(volatile LONG *); // [sp+94h] [bp-A38h]@25
  WCHAR Buffer; // [sp+98h] [bp-A34h]@2
  WCHAR pszDest; // [sp+298h] [bp-834h]@6
  WCHAR Filename; // [sp+4A4h] [bp-628h]@6
  WCHAR Str; // [sp+6B0h] [bp-41Ch]@6
  WCHAR pszDir; // [sp+8BCh] [bp-210h]@6

  if ( !dword_6C365774 )
  {
    OSVersion::GetVersionID((OSVersion *)&unk_6C36687C, (unsigned __int32 *)&unk_6C366880, a1);
    dword_6C366884 = GetCurrentThreadId();
    TlsAlloc();
    TlsAlloc();
    pcbBuffer = 256;
    GetUserNameW(&Buffer, &pcbBuffer);
    dword_6C366888 = wcscmp(&Buffer, L"yboxrunner") == 0;
    dword_6C36688C = GetModuleHandleW(L"libtcmalloc.dll");
    if ( !wcsstr(::Str, L"/TraceThirdPartyModuleLoad") )
      wcsstr(::Str, L"/NotTraceThirdPartyModuleLoad");
    if ( !wcsstr(::Str, L"/DisableLoadNoInfoModule") )
      wcsstr(::Str, L"/AllowLoadNoInfoModule");
    v1 = 0;
    Filename = 0;
    GetModuleFileNameW(0, &Filename, 0x105u);
    *wcsrchr(&Filename, 0x5Cu) = 0;
    CTXStringW::operator=(&unk_6C3657BC, &Filename);
    Str = 0;
    GetSystemDirectoryW(&Str, 0x105u);
    *wcsrchr(&Str, 0x5Cu) = 0;
    CTXStringW::operator=(&unk_6C3657C0, &Str);
    pszDir = 0;
    GetWindowsDirectoryW(&pszDir, 0x105u);
    *wcsrchr(&pszDir, 0x5Cu) = 0;
    CTXStringW::operator=(&unk_6C3657C8, &pszDir);
    pszDest = 0;
    PathCombineW(&pszDest, &pszDir, L"system");
    CTXStringW::operator=(&unk_6C3657C4, &pszDest);
    if ( (unsigned int)((dword_6C3657E0 - (signed int)dword_6C3657D8) >> 2) < 3 )
      sub_6C34496E(3);
    CTXStringW::CTXStringW(&v39, &Str);
    if ( dword_6C3657E0 == dword_6C3657DC )
    {
      sub_6C344C70(dword_6C3657DC, &v39);
    }
    else
    {
      CTXStringW::CTXStringW(dword_6C3657DC, &v39);
      dword_6C3657DC += 4;
    }
    CTXStringW::~CTXStringW((CTXStringW *)&v39);
    CTXStringW::CTXStringW(&v39, &pszDest);
    if ( dword_6C3657E0 == dword_6C3657DC )
    {
      sub_6C344C70(dword_6C3657DC, &v39);
    }
    else
    {
      CTXStringW::CTXStringW(dword_6C3657DC, &v39);
      dword_6C3657DC += 4;
    }
    CTXStringW::~CTXStringW((CTXStringW *)&v39);
    CTXStringW::CTXStringW(&v39, &pszDir);
    if ( dword_6C3657E0 == dword_6C3657DC )
    {
      sub_6C344C70(dword_6C3657DC, &v39);
    }
    else
    {
      CTXStringW::CTXStringW(dword_6C3657DC, &v39);
      dword_6C3657DC += 4;
    }
    CTXStringW::~CTXStringW((CTXStringW *)&v39);
    if ( (unsigned int)((dword_6C3657D4 - (signed int)::Memory) >> 2) < 0x32 )
      sub_6C34496E(50);
    v2 = GetEnvironmentVariableW(L"Path", 0, 0);
    CTXStringW::CTXStringW(&v38, v26);
    v26 = v2;
    v3 = CTXStringW::GetBuffer((CTXStringW *)&v38, v2);
    GetEnvironmentVariableW(L"Path", v3, v4);
    CTXStringW::ReleaseBuffer((CTXStringW *)&v38, -1);
    lpProcName = CTXStringW::GetBuffer((CTXStringW *)&v38);
    for ( i = wcstok(lpProcName, L";"); i; i = wcstok(0, L";") )
    {
      CTXStringW::CTXStringW(&v39, i);
      if ( dword_6C3657D4 == dword_6C3657D0 )
      {
        sub_6C344C70(dword_6C3657D0, &v39);
      }
      else
      {
        CTXStringW::CTXStringW(dword_6C3657D0, &v39);
        dword_6C3657D0 += 4;
      }
      CTXStringW::~CTXStringW((CTXStringW *)&v39);
    }
    CTXStringW::ReleaseBuffer((CTXStringW *)&v38, -1);
    CTXStringW::~CTXStringW((CTXStringW *)&v38);
    Memory = 0;
    v36 = 0;
    v37 = 0;
    sub_6C3448F6(100);
    v40 = (int (__cdecl *)(volatile LONG *))PostQuitMessage;
    sub_6C3447ED(&v40);
    v40 = (int (__cdecl *)(volatile LONG *))CreateProcessW;
    sub_6C3447ED(&v40);
    v40 = (int (__cdecl *)(volatile LONG *))ExitProcess;
    sub_6C3447ED(&v40);
    v40 = (int (__cdecl *)(volatile LONG *))TerminateProcess;
    sub_6C3447ED(&v40);
    v40 = (int (__cdecl *)(volatile LONG *))exit;
    sub_6C3447ED(&v40);
    v40 = (int (__cdecl *)(volatile LONG *))exit;
    sub_6C3447ED(&v40);
    v40 = (int (__cdecl *)(volatile LONG *))PostThreadMessageW;
    sub_6C3447ED(&v40);
    v40 = (int (__cdecl *)(volatile LONG *))TerminateThread;
    sub_6C3447ED(&v40);
    v40 = (int (__cdecl *)(volatile LONG *))FreeLibrary;
    sub_6C3447ED(&v40);
    v40 = (int (__cdecl *)(volatile LONG *))ImmAssociateContext;
    sub_6C3447ED(&v40);
    v40 = (int (__cdecl *)(volatile LONG *))ImmAssociateContextEx;
    sub_6C3447ED(&v40);
    v40 = sub_6C343A94;
    sub_6C3447ED(&v40);
    v40 = (int (__cdecl *)(volatile LONG *))CloseHandle;
    sub_6C3447ED(&v40);
    v40 = (int (__cdecl *)(volatile LONG *))closesocket;
    sub_6C3447ED(&v40);
    v40 = (int (__cdecl *)(volatile LONG *))sub_6C34515E;
    sub_6C3447ED(&v40);
    v40 = (int (__cdecl *)(volatile LONG *))sub_6C345123;
    sub_6C3447ED(&v40);
    v7 = GetModuleHandleW(L"ntdll.dll");
    v8 = v7;
    v9 = GetProcAddress(v7, "LdrUnloadDll");
    v27 = v9;
    if ( v9 )
    {
      v40 = (int (__cdecl *)(volatile LONG *))v9;
      sub_6C3447ED(&v40);
    }
    v10 = GetProcAddress(v8, "LdrLoadDll");
    if ( v10 )
    {
      v40 = (int (__cdecl *)(volatile LONG *))v10;
      sub_6C3447ED(&v40);
    }
    v11 = GetProcAddress(v8, "LdrShutdownProcess");
    v29 = v11;
    if ( v11 )
    {
      v40 = (int (__cdecl *)(volatile LONG *))v11;
      sub_6C3447ED(&v40);
    }
    v12 = GetModuleHandleW(L"Kernel32.dll");
    v13 = GetProcAddress(v12, "RegisterApplicationRestart");
    v28 = v13;
    if ( v13 )
    {
      v30 = v13;
      sub_6C3447ED(&v30);
    }
    v14 = dword_6C36688C;
    v32 = dword_6C36688C;
    v40 = 0;
    if ( dword_6C36688C )
    {
      v15 = GetProcAddress(dword_6C36688C, "tc_version");
      v39 = 0;
      v40 = (int (__cdecl *)(volatile LONG *))(v14 + 12136);
      v34 = 0;
      Str1 = 0;
      ((void (__cdecl *)(int *, int *, char **))v15)(&v39, &v34, &Str1);
      CTXStringW::CTXStringW(&v38, v25);
      CTXStringW::GetBuffer((CTXStringW *)&v38, 256);
      CTXStringW::operator=(&v38, &word_6C355078);
      if ( v39 != 2 )
        CTXStringW::AppendFormat((CTXStringW *)&v38, L"major!=2,==%d\r\n", v39);
      if ( v34 != 5 )
        CTXStringW::AppendFormat((CTXStringW *)&v38, L"minor!=5,==%d\r\n", v34);
      if ( strcmp(Str1, ".93") )
        CTXStringW::AppendFormat((CTXStringW *)&v38, L"patch!=.93,==%S\r\n", Str1);
      v16 = *((_WORD *)v32 + 25768);
      if ( v16 != -29867 && v16 != -16333 )
        CTXStringW::AppendFormat((CTXStringW *)&v38, L"*(WORD*)pfnPatchAllModules offset position mismatch\r\n");
      if ( (unsigned __int8)operator==(&v38, &word_6C355078) )
      {
        v1 = 1;
        dword_6C3668CC = (int)GetProcAddress(dword_6C36688C, "tc_malloc_size");
        v32 = (HMODULE)v40;
        sub_6C3447ED(&v32);
      }
      CTXStringW::~CTXStringW((CTXStringW *)&v38);
    }
    Util::Misc::CSafeHook::CSafeHook(&v26);
    if ( v29 )
      DetourFunctionWrapper(v29, sub_6C3439BF, &dword_6C3668E4);
    DetourFunctionWrapper(PostQuitMessage, sub_6C3428CF, &dword_6C366890);
    DetourFunctionWrapper(CreateProcessW, sub_6C342BF7, &dword_6C3668A8);
    DetourFunctionWrapper(ExitProcess, sub_6C342947, &dword_6C366894);
    DetourFunctionWrapper(TerminateProcess, sub_6C3429AE, &dword_6C366898);
    DetourFunctionWrapper(exit, sub_6C342AA7, &dword_6C36689C);
    DetourFunctionWrapper(exit, sub_6C342B0D, &dword_6C3668A0);
    DetourFunctionWrapper(PostThreadMessageW, sub_6C342B73, &dword_6C3668A4);
    DetourFunctionWrapper(TerminateThread, sub_6C342C53, &dword_6C3668AC);
    DetourFunctionWrapper(ImmAssociateContext, sub_6C342DA2, &dword_6C3668B0);
    DetourFunctionWrapper(ImmAssociateContextEx, sub_6C342DFF, &dword_6C3668B4);
    if ( v28 )
      DetourFunctionWrapper(v28, sub_6C3439CF, &dword_6C3668E8);
    if ( v27 )
      DetourFunctionWrapper(v27, sub_6C343119, &dword_6C3668BC);
    else
      DetourFunctionWrapper(FreeLibrary, sub_6C342E62, &dword_6C3668B8);
    if ( v1 )
    {
      DetourFunctionWrapper(v40, sub_6C34372C, &unk_6C3668C8);
      v17 = dword_6C366888;
      if ( wcsstr(::Str, L"/SaveFreeCallStack") )
        goto LABEL_68;
      if ( wcsstr(::Str, L"/NotSaveFreeCallStack") )
        v17 = 0;
      if ( v17 )
      {
LABEL_68:
        v18 = GetProcAddress(dword_6C36688C, "MallocHook_AddNewHook");
        ((void (__cdecl *)(int (__cdecl *)(int, int)))v18)(sub_6C3435FC);
        v19 = GetProcAddress(dword_6C36688C, "MallocHook_AddDeleteHook");
        ((void (__cdecl *)(int (__cdecl *)(int)))v19)(sub_6C3436D6);
      }
    }
    if ( wcsstr(::Str, L"/HookHeapAlloc") )
    {
      CTXStringW::CTXStringW(&v40, &Memory);
      v20 = GetCurrentProcessId();
      CTXStringW::Format((CTXStringW *)&v40, L"C:\\mylog_pid%u.txt", v20);
      v21 = (const wchar_t *)CTXStringW::operator wchar_t const *(&v40);
      File = wfopen(v21, L"w+");
      DetourFunctionWrapper(GlobalAlloc, sub_6C343732, &dword_6C3668D4);
      DetourFunctionWrapper(LocalAlloc, sub_6C3437BA, &dword_6C3668D8);
      DetourFunctionWrapper(HeapAlloc, sub_6C343842, &dword_6C3668DC);
      DetourFunctionWrapper(HeapReAlloc, sub_6C3438D0, &dword_6C3668E0);
      CTXStringW::~CTXStringW((CTXStringW *)&v40);
    }
    DetourFunctionWrapper(sub_6C34515E, sub_6C34349F, &unk_6C3668C0);
    DetourFunctionWrapper(sub_6C345123, sub_6C3434D9, &unk_6C3668C4);
    v22 = GetModuleHandleW(L"kernel32.dll");
    v23 = GetProcAddress(v22, "GetLocaleInfoEx");
    if ( v23 )
      DetourFunctionWrapper(v23, sub_6C343A42, &dword_6C3668EC);
    dword_6C365774 = 1;
    Util::Misc::CSafeHook::~CSafeHook((Util::Misc::CSafeHook *)&v26);
    if ( Memory )
      sub_6C331E7B(Memory, (v37 - (_DWORD)Memory) & 0xFFFFFFFC);
  }
  return &unk_6C366808;
}

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


============================================================================================================================================================================================================================================================================================================================================================================

============================================================================================================================================================================================================================================================================================================================================================================


============================================================================================================================================================================================================================================================================================================================================================================

============================================================================================================================================================================================================================================================================================================================================================================


============================================================================================================================================================================================================================================================================================================================================================================

============================================================================================================================================================================================================================================================================================================================================================================


============================================================================================================================================================================================================================================================================================================================================================================

============================================================================================================================================================================================================================================================================================================================================================================


============================================================================================================================================================================================================================================================================================================================================================================

============================================================================================================================================================================================================================================================================================================================================================================


============================================================================================================================================================================================================================================================================================================================================================================

============================================================================================================================================================================================================================================================================================================================================================================


============================================================================================================================================================================================================================================================================================================================================================================

============================================================================================================================================================================================================================================================================================================================================================================


============================================================================================================================================================================================================================================================================================================================================================================

============================================================================================================================================================================================================================================================================================================================================================================


============================================================================================================================================================================================================================================================================================================================================================================

============================================================================================================================================================================================================================================================================================================================================================================


============================================================================================================================================================================================================================================================================================================================================================================

============================================================================================================================================================================================================================================================================================================================================================================


============================================================================================================================================================================================================================================================================================================================================================================

============================================================================================================================================================================================================================================================================================================================================================================


============================================================================================================================================================================================================================================================================================================================================================================

============================================================================================================================================================================================================================================================================================================================================================================


============================================================================================================================================================================================================================================================================================================================================================================

============================================================================================================================================================================================================================================================================================================================================================================


============================================================================================================================================================================================================================================================================================================================================================================

============================================================================================================================================================================================================================================================================================================================================================================


============================================================================================================================================================================================================================================================================================================================================================================

============================================================================================================================================================================================================================================================================================================================================================================


============================================================================================================================================================================================================================================================================================================================================================================

============================================================================================================================================================================================================================================================================================================================================================================

